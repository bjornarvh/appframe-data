import EventEmitter from"eventemitter3";function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function _classPrivateFieldGet(a,b){if(!b.has(a))throw new TypeError("attempted to get private field on non-instance");return b.get(a).value}function _classPrivateFieldSet(a,b,c){if(!b.has(a))throw new TypeError("attempted to set private field on non-instance");var d=b.get(a);if(!d.writable)throw new TypeError("attempted to set read only private field");return d.value=c,c}function fireCallback(a){if("function"==typeof a){for(var b=arguments.length,c=Array(1<b?b-1:0),d=1;d<b;d++)c[d-1]=arguments[d];a(...c)}}class DataHandler{constructor(a){const b=a.articleId,c=a.dataSourceId,d=a.fields,e=a.groupBy,f=a.timeout;b?this.articleId=b:window.af&&window.af.article&&(this.articleId=window.af.article.id),this.dataSourceId=c||null,this.fields=d||null,this.groupBy=e||null,this.timeout=f||3e4}create(a,b){return this.request("create",a,b)}destroy(a,b){return this.request("destroy",a,b)}retrieve(a,b){return this.request("retrieve",a,b)}update(a,b){return this.request("update",a,b)}request(a,b,c){return new Promise((d,e)=>{const f={body:JSON.stringify(b),method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"}};let g=null,h=`/${a}/${this.articleId}/${this.dataSourceId}`,i=!1;this.fields&&(h+=`/${this.fields instanceof Array?this.fields.join("-"):this.fields}`),this.groupBy&&(h+="/"+this.groupBy),window.AbortController&&(this.previousRequestController&&this.previousRequestController.abort(),g=new window.AbortController,this.previousRequestController=g,f.signal=this.previousRequestController.signal);const j=setTimeout(()=>{g&&g.abort(),i=!0,d(!1)},this.timeout);fetch(h,f).then(a=>(clearTimeout(j),!(i||g&&this.previousRequestController!==g)&&a.json())).then(a=>{!1===a?d(!1):a.hasOwnProperty("success")?(fireCallback(c,null,a.success),d(a.success)):a.hasOwnProperty("error")&&(fireCallback(c,null,a.error),e(a.error))}).catch(a=>{"Aborted"===a.message||window.AbortError&&a instanceof window.AbortError?d(!1):e(a)})})}}class MemoryStorage{constructor(){_defineProperty(this,"data",[])}create(a){if("object"!=typeof a)throw new TypeError("Record must be an object");return this.data.push(a)-1}destroy(){let a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:null;if(null!==this.getRecord())return this.data.splice(a,1),!0;throw new Error(`No record found for index ${a}`)}getRecord(){let a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:null;return this.data[a]||null}length(){return this.data.length}retrieve(){let a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:null;return"number"!=typeof a||isNaN(a)?this.data:this.getRecorddata[a]||null}update(a,b){const c=this.getRecord(a);if(c)this.data[a]=b instanceof Array?b:Object.assign({},this.data[a],b);else throw new Error(`No record found for index ${a}`);return!0}}const defaultOptions={dataHandler:null,articleId:window.af&&window.af.article&&window.af.article.id,dataSourceId:null,timeout:3e4,errorHandler:function(a,b){window.alert(a),fireCallback(b,a,null)},linkFields:null,disableAutoload:!1,dynamicLoading:!1,allowDelete:!1,allowUpdate:!1,allowInsert:!1,strict:!1,selectFirstRow:!0,optimisticLocking:!1,hasIITrig:!1,hasIUTrig:!1,hasIDTrig:!1,parameters:{filterString:"",whereClause:"",filterObject:null,whereObject:null,sortOrder:[],maxRecords:-1,distinctRows:!1,masterChildCriteria:{}},systemFieldNames:{},masterDataObject:null,groupBy:null,uniqueIdField:"PrimKey",fields:[]};class DataObject extends EventEmitter{constructor(a){super(),_dataHandler.set(this,{writable:!0,value:void 0}),_storageEngine.set(this,{writable:!0,value:new MemoryStorage}),_options.set(this,{writable:!0,value:void 0}),_fieldNames.set(this,{writable:!0,value:[]}),_parametersChanged.set(this,{writable:!0,value:!1}),_currentIndex.set(this,{writable:!0,value:null}),_errorRecords.set(this,{writable:!0,value:{}}),_dirtyRecords.set(this,{writable:!0,value:{}}),_savingRecords.set(this,{writable:!0,value:{}}),_newRecord.set(this,{writable:!0,value:{}}),_dataLoaded.set(this,{writable:!0,value:null}),_dataSaving.set(this,{writable:!0,value:!1}),_dataLoading.set(this,{writable:!0,value:!1}),_temporarilyDisallowDelete.set(this,{writable:!0,value:!1}),_temporarilyDisallowUpdate.set(this,{writable:!0,value:!1}),_temporarilyDisallowInsert.set(this,{writable:!0,value:!1}),_classPrivateFieldSet(this,_options,Object.assign({},defaultOptions,a)),a.parameters&&(_classPrivateFieldGet(this,_options).parameters=Object.assign({},defaultOptions.parameters,a.parameters)),_classPrivateFieldSet(this,_dataHandler,a.dataHandler||new DataHandler({articleId:a.articleId,dataSourceId:a.dataSourceId,timeout:a.timeout})),delete _classPrivateFieldGet(this,_options).dataHandler,delete _classPrivateFieldGet(this,_options).storageEngine,this.initialize()}attachEvent(a,b){super.on.call(this,a,b)}detachEvent(a,b){super.removeListener.call(this,a,b)}cancelEdit(){}cancelField(){}currentRow(){}endEdit(){}deleteCurrentRow(){return new Promise(()=>{})}deleteRow(){return new Promise(()=>{})}initialize(){this.fields||this.getFieldsAsync().then(a=>{this.fields=a,this.initialize=null}),this.initialize=function(){console.warn(`Data object ${this.dataSourceId} has already been initialized.`)}}isDataLoaded(){}isDataLoading(){}isDeleteAllowed(){}isUpdateAllowed(){}isInsertAllowed(){}isDeleteNeverAllowed(){}isUpdateNeverAllowed(){}isInsertNeverAllowed(){}getCurrentIndex(){}getData(){}getDataLength(){}getDataSourceId(){}getFields(){}getFieldsAsync(){}getMasterDataObject(){return _classPrivateFieldGet(this,_options).masterDataObject}getParameter(a){return _classPrivateFieldGet(this,_options).parameters[a]||null}refreshCurrentRow(){return new Promise(()=>{})}refreshDataSource(){return new Promise(()=>{})}refreshRow(){return new Promise(()=>{})}setAllowDelete(){}setAllowUpdate(){}setAllowInsert(){}setParameter(a,b){const c=["filterString","whereClause"].includes(a);if(_classPrivateFieldGet(this,_options).strict&&c)throw new Error(`Setting ${a} is not allowed when dataObject is in strict mode`);c&&(!b&&(b=""),this.setParameter("filterString"===a?"filterObject":"whereObject",null));const d=_classPrivateFieldGet(this,_options).parameters[a];d!==b&&(_classPrivateFieldGet(this,_options).parameters[a]=b,this.emit("onParameterUpdated",a))}}var _dataHandler=new WeakMap,_storageEngine=new WeakMap,_options=new WeakMap,_fieldNames=new WeakMap,_parametersChanged=new WeakMap,_currentIndex=new WeakMap,_errorRecords=new WeakMap,_dirtyRecords=new WeakMap,_savingRecords=new WeakMap,_newRecord=new WeakMap,_dataLoaded=new WeakMap,_dataSaving=new WeakMap,_dataLoading=new WeakMap,_temporarilyDisallowDelete=new WeakMap,_temporarilyDisallowUpdate=new WeakMap,_temporarilyDisallowInsert=new WeakMap;export default DataObject;
